# Malware Analysis
*Write up and utils*

## Agent Tesla

Analyzed VB dropper: https://www.hybrid-analysis.com/sample/b49bbeb7c2d900427b84830b9d9db13305e27f28ca001afc39a7a867548389c2  
Analyzed .NET sample: https://www.hybrid-analysis.com/sample/9b39aa6eca080dd42b880e837034dd131341eb3ec20988ab8c9f893fc97b293b

**decrypt_tesla_strings.py**: it decrypts strings embedded in the .NET Agent Tesla executable. To use it, `pip install pycryptodome`, then run the script with a file containing the encrypted strings. The format should correspond to an array of the following structure:
```C
struct encrypted_string{
    unsigned int length; // length of cipher is variable
    char key[32];
    char iv[16];
    char *cipher;
};
```
It follows the same structure that the one in Agent Tesla except for the length attribute. The script `write_buf.py` can be used to create the file, once the buffer of encrypted strings is extracted using a decompiler like dnSpy. A less dirty way would be to detect and extract the buffer directly from memory. ;)

![agent_tesla_encrypted_strings](./agent_tesla/utils/agent_tesla.PNG)


## Emotet

Sample Word Document (dropper for Emotet trojan) : https://www.virustotal.com/gui/file/0a875a5761c5696b3eb1d407a4132c10b40e4303942d3b87cbe4c43bc9246404/detection

**emotet_maldoc_urls.py**: An improved and updated version of https://gist.github.com/psrok1/bec5de0ada31a5a9b1dc56fde0d72214. It extracts Powershell dropper from malicious Word document, in order to get unique URLs used by Emotet to download the next stage, that is the Emotet backdoor. This script was developed because I needed to extract unique URLs from hundreds of malicious documents. It at least works for the late 2019 campaign with the following template. For others, it might need some reajustments.

![doc template sample](./emotet/utils/doc_sample.jpg)

It requires oledump.py to be on the same directory, Python2, and `pip install olefile`. Run the script with, as an argument, a repository containing the malicious documents. 

`python2 emotet_maldoc_urls ./path/to/malicious_docs/`

The found unique urls are stored in the file `found_unique_urls.txt`.

